{{- if eq .chezmoi.os "linux" -}}
{{- if eq .chezmoi.osRelease.id "arch" -}}
#!/bin/bash

# Install pacman packages
{{- if .packages.arch.pacman }}
echo "Installing pacman packages..."
sudo pacman -S --needed --noconfirm \
{{- range .packages.arch.pacman }}
  {{ . }} \
{{- end }}
  2>/dev/null || true
{{- end }}

# Install AUR packages (requires yay or paru)
{{- if .packages.arch.aur }}
if command -v yay &> /dev/null; then
  echo "Installing AUR packages with yay..."
  yay -S --needed --noconfirm \
{{- range .packages.arch.aur }}
    {{ . }} \
{{- end }}
    2>/dev/null || true
elif command -v paru &> /dev/null; then
  echo "Installing AUR packages with paru..."
  paru -S --needed --noconfirm \
{{- range .packages.arch.aur }}
    {{ . }} \
{{- end }}
    2>/dev/null || true
else
  echo "Warning: No AUR helper found (yay or paru). Skipping AUR packages."
  echo "AUR packages to install manually:"
{{- range .packages.arch.aur }}
  echo "  - {{ . }}"
{{- end }}
fi
{{- end }}

{{- end }}
{{- end }}

# Configure keyd
if command -v keyd &> /dev/null; then
  echo "Setting up keyd..."
  
  # Create global keyd config
  sudo mkdir -p /etc/keyd
  sudo tee /etc/keyd/default.conf > /dev/null << 'EOF'
[ids]
*

[main]
# Caps Lock dual function: tap (<100ms) for Escape, hold for Caps Lock (which becomes MOD5 via XKB)
capslock = timeout(esc, 100, capslock)

# Global Alt+Shift+bracket for tab switching (works everywhere)
[alt+shift]
[ = C-pageup
] = C-pagedown

# Note: Alt+bracket (without Shift) for browser back/forward is handled 
# per-application via keyd-application-mapper (see ~/.config/keyd/app.conf)
EOF
  
  echo "Updated keyd config"
  
  # Enable keyd service if not already enabled
  if ! systemctl is-enabled keyd &> /dev/null; then
    sudo systemctl enable --now keyd
    echo "keyd service enabled and started"
  else
    # Reload to apply any config changes
    sudo keyd reload
    echo "keyd config reloaded"
  fi
  
  # Add user to keyd group for keyd-application-mapper
  if ! groups | grep -q keyd; then
    sudo usermod -aG keyd $USER
    echo "Added $USER to keyd group (re-login required for group change to take effect)"
  fi
fi

# Install Python tools with uv (cross-platform)
{{- if .packages.python.uv.tools }}
if command -v uv &> /dev/null; then
  echo "Installing Python tools with uv..."
{{- range .packages.python.uv.tools }}
  uv tool install {{ . | quote }}
{{- end }}
else
  echo "Warning: uv not found. Skipping Python tools installation."
fi
{{- end }}