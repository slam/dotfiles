{{- if eq .chezmoi.os "linux" -}}
{{- if eq .chezmoi.osRelease.id "arch" -}}
#!/bin/bash

# Install pacman packages
{{- if .packages.arch.pacman }}
echo "Installing pacman packages..."
sudo pacman -S --needed --noconfirm \
{{- range .packages.arch.pacman }}
  {{ . }} \
{{- end }}
  2>/dev/null || true
{{- end }}

# Install AUR packages (requires yay or paru)
{{- if .packages.arch.aur }}
if command -v yay &> /dev/null; then
  echo "Installing AUR packages with yay..."
  yay -S --needed --noconfirm \
{{- range .packages.arch.aur }}
    {{ . }} \
{{- end }}
    2>/dev/null || true
elif command -v paru &> /dev/null; then
  echo "Installing AUR packages with paru..."
  paru -S --needed --noconfirm \
{{- range .packages.arch.aur }}
    {{ . }} \
{{- end }}
    2>/dev/null || true
else
  echo "Warning: No AUR helper found (yay or paru). Skipping AUR packages."
  echo "AUR packages to install manually:"
{{- range .packages.arch.aur }}
  echo "  - {{ . }}"
{{- end }}
fi
{{- end }}

{{- end }}
{{- end }}

# Configure interception-tools for Hyper key
if command -v intercept &> /dev/null && command -v dual-function-keys &> /dev/null; then
  echo "Setting up interception-tools..."
  
  # Create configs in /etc/interception if they don't exist
  if [ ! -f /etc/interception/dual-function-keys.yaml ]; then
    sudo mkdir -p /etc/interception
    
    # Create dual-function-keys config
    sudo tee /etc/interception/dual-function-keys.yaml > /dev/null << 'EOF'
TIMING:
  TAP_MILLISEC: 200
  DOUBLE_TAP_MILLISEC: 0

MAPPINGS:
  - KEY: KEY_CAPSLOCK
    TAP: KEY_ESC
    HOLD: KEY_CAPSLOCK  # Acts as MOD5 in Hyprland with lv3:caps_switch
EOF
    
    # Create udevmon config
    sudo tee /etc/interception/udevmon.yaml > /dev/null << 'EOF'
- JOB: intercept -g $DEVNODE | dual-function-keys -c /etc/interception/dual-function-keys.yaml | uinput -d $DEVNODE
  DEVICE:
    EVENTS:
      EV_KEY: [KEY_CAPSLOCK]
EOF
    
    echo "Created interception-tools configs"
  fi
  
  # Enable udevmon service if not already enabled
  if ! systemctl is-enabled udevmon &> /dev/null; then
    sudo systemctl enable --now udevmon
    echo "udevmon service enabled and started"
  else
    echo "udevmon service already enabled"
  fi
fi

# Install Python tools with uv (cross-platform)
{{- if .packages.python.uv.tools }}
if command -v uv &> /dev/null; then
  echo "Installing Python tools with uv..."
{{- range .packages.python.uv.tools }}
  uv tool install {{ . | quote }}
{{- end }}
else
  echo "Warning: uv not found. Skipping Python tools installation."
fi
{{- end }}